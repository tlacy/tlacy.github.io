<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Manage content — tomlacy.net</title>
  <style>
    body{font-family: system-ui, sans-serif; margin:16px; max-width:1100px}
    textarea{width:100%;height:320px;font-family:monospace;padding:12px}
    label{font-weight:600}
    .row{display:flex;gap:12px}
    .col{flex:1}
    button{padding:8px 12px;border-radius:6px}
  </style>
}</head>
<body>
  <h1>Manage site content (local only)</h1>
  <p>This page lets you edit <code>career.md</code> and <code>content.json</code> in your browser. You can either download changes and commit manually, or sign in with GitHub and "Save to GitHub" to create a PR (recommended). The GitHub flow requires the site to be deployed with the included Netlify Functions and environment variables configured.</p>

  <div>
    <label for="career">career.md</label>
    <textarea id="career" placeholder="career markdown"></textarea>
    <p><button id="download-career">Download career.md</button></p>
  </div>

  <div>
    <label for="contentjson">content.json</label>
    <textarea id="contentjson" placeholder="content.json"></textarea>
    <p><button id="download-content">Download content.json</button></p>
  </div>

  <!-- Simple client-side login (convenience gate) -->
  <div id="login-overlay" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1200">
    <div style="background:#fff;padding:20px;border-radius:8px;max-width:420px;width:100%">
      <h2 style="margin-top:0">Sign in to manage content</h2>
      <p style="color:#444">This page is a local, client-side editor. The login here is a convenience gate only — it is not a secure authentication mechanism. For real access control, host this page behind HTTP auth or use an OAuth-backed service.</p>
      <label for="login-pass">Password</label>
      <input id="login-pass" type="password" style="width:100%;padding:8px;margin-top:6px" placeholder="Enter password" />
      <p style="margin-top:10px"><button id="login-btn">Sign in</button> <button id="login-logout" style="display:none">Sign out</button></p>
      <p style="font-size:0.9rem;color:#666">Default password: <strong>tomalacy</strong>. Change this value in the manage.html script for better privacy.</p>
    </div>
  </div>

  <div style="margin-top:18px;border-top:1px solid #eee;padding-top:12px">
    <h3>People / Team Leadership (site-managed)</h3>
    <div class="row">
      <div class="col">
        <label for="people-email">Contact email</label>
        <input id="people-email" type="email" placeholder="tomalacy@gmail.com" style="width:100%;padding:8px;margin-top:6px" />
      </div>
    </div>
    <div style="margin-top:12px">
      <label for="people-content">Leadership section HTML / markdown</label>
      <textarea id="people-content" placeholder="Write content that will appear in the People / Team Leadership section"></textarea>
      <p><small>Content will be embedded into <code>content.json</code> under a `people` object when you download.</small></p>
    </div>
  </div>

  <script>
    async function loadText(path){
      try{const r=await fetch(path); if(!r.ok) throw new Error('fetch failed'); return await r.text()}catch(e){return ''}
    }
    (async ()=>{
      document.getElementById('career').value = await loadText('career.md');
      document.getElementById('contentjson').value = await loadText('content.json');
      // Try to populate people fields from content.json if present
      try{
        const c = JSON.parse(document.getElementById('contentjson').value || '{}');
        if(c.people){
          document.getElementById('people-email').value = c.people.contactEmail || '';
          document.getElementById('people-content').value = c.people.content || '';
        }
      }catch(e){}
    })();

    // --- Simple client-side login logic ---
    (function(){
      // WARNING: this is client-side only. Do not rely on it for strong security.
      const DEFAULT_PASSWORD = 'tomalacy'; // change this value in the file
      const overlay = document.getElementById('login-overlay');
      const passInput = document.getElementById('login-pass');
      const loginBtn = document.getElementById('login-btn');
      const logoutBtn = document.getElementById('login-logout');

      function setLocked(locked){
        const textareas = document.querySelectorAll('textarea, input');
        textareas.forEach(el => {
          if(el.id === 'login-pass' || el.id === 'login-btn' || el.id === 'login-logout') return;
          if(locked){ el.setAttribute('disabled','disabled'); } else { el.removeAttribute('disabled'); }
        });
        document.getElementById('download-content').disabled = locked;
        document.getElementById('download-career').disabled = locked;
      }

      function isLoggedIn(){ return sessionStorage.getItem('manageLoggedIn') === '1'; }

      function showOverlay(show){ overlay.style.display = show ? 'flex' : 'none'; }

      loginBtn.addEventListener('click', ()=>{
        const val = passInput.value || '';
        if(val === DEFAULT_PASSWORD){
          sessionStorage.setItem('manageLoggedIn','1');
          setLocked(false);
          showOverlay(false);
          logoutBtn.style.display = 'inline-block';
        } else {
          alert('Incorrect password');
        }
      });

      logoutBtn.addEventListener('click', ()=>{
        sessionStorage.removeItem('manageLoggedIn');
        setLocked(true);
        showOverlay(true);
        logoutBtn.style.display = 'none';
      });

      // Initialize
      if(isLoggedIn()){
        setLocked(false);
        showOverlay(false);
        logoutBtn.style.display = 'inline-block';
      } else {
        setLocked(true);
        showOverlay(true);
      }
    })();

    function download(filename, text){
      const blob = new Blob([text], {type: 'text/plain;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }
    document.getElementById('download-career').addEventListener('click', ()=> download('career.md', document.getElementById('career').value));
    document.getElementById('download-content').addEventListener('click', ()=> {
      // Merge people fields into the JSON before download
      try{
        const raw = document.getElementById('contentjson').value || '{}';
        const obj = JSON.parse(raw);
        obj.people = obj.people || {};
        const email = document.getElementById('people-email').value || '';
        const content = document.getElementById('people-content').value || '';
        obj.people.contactEmail = email;
        obj.people.content = content;
        download('content.json', JSON.stringify(obj, null, 2));
      }catch(e){
        // fallback: download raw textarea
        download('content.json', document.getElementById('contentjson').value);
      }
    });

    // --- GitHub OAuth + commit support ---
  const ghSignInBtn = document.createElement('button'); ghSignInBtn.textContent = 'Sign in with GitHub';
  const ghSaveBtn = document.createElement('button'); ghSaveBtn.textContent = 'Save to GitHub'; ghSaveBtn.style.marginLeft='8px';
  const draftCheckbox = document.createElement('input'); draftCheckbox.type='checkbox'; draftCheckbox.id='pr-draft';
  const draftLabel = document.createElement('label'); draftLabel.htmlFor='pr-draft'; draftLabel.textContent='Create draft PR'; draftLabel.style.marginLeft='6px';
  const ghStatus = document.createElement('span'); ghStatus.style.marginLeft='12px';
  const prLink = document.createElement('a'); prLink.style.marginLeft='12px'; prLink.target='_blank';
  const ctrlRow = document.createElement('p'); ctrlRow.appendChild(ghSignInBtn); ctrlRow.appendChild(ghSaveBtn); ctrlRow.appendChild(draftCheckbox); ctrlRow.appendChild(draftLabel); ctrlRow.appendChild(ghStatus); ctrlRow.appendChild(prLink);
    document.body.insertBefore(ctrlRow, document.body.firstChild);

    function getTokenFromFragment(){
      const f = location.hash || '';
      const m = f.match(/gh_token=([^&]+)/);
      return m ? decodeURIComponent(m[1]) : (sessionStorage.getItem('gh_token') || null);
    }

    function setToken(t){ if(t){ sessionStorage.setItem('gh_token', t); ghStatus.textContent = 'Signed in'; } else { sessionStorage.removeItem('gh_token'); ghStatus.textContent = 'Signed out'; } }

    // On load, check hash
    (function(){ const t = getTokenFromFragment(); if(t){ setToken(t); history.replaceState(null,'',location.pathname+location.search); } const cur = sessionStorage.getItem('gh_token'); if(cur) ghStatus.textContent = 'Signed in'; else ghStatus.textContent = 'Not signed in'; })();

    ghSignInBtn.addEventListener('click', ()=>{
      // start oauth flow via netlify function
      window.location = '/.netlify/functions/oauth_start';
    });

    ghSaveBtn.addEventListener('click', async ()=>{
      const token = sessionStorage.getItem('gh_token');
      if(!token){ alert('Sign in with GitHub first'); return; }
      // Build content.json merged object
      try{
        const raw = document.getElementById('contentjson').value || '{}';
        const obj = JSON.parse(raw);
        obj.people = obj.people || {};
        obj.people.contactEmail = document.getElementById('people-email').value || obj.people.contactEmail || '';
        obj.people.content = document.getElementById('people-content').value || obj.people.content || '';
        const payload = { owner: 'tlacy', repo: 'tlacy.github.io', branch: 'main', path: 'content.json', content: JSON.stringify(obj, null, 2), message: 'Update content.json via manage.html' };
        // include draft preference
        payload.createDraft = document.getElementById('pr-draft') ? document.getElementById('pr-draft').checked : false;
        const res = await fetch('/.netlify/functions/commit', { method: 'POST', headers: { 'Content-Type':'application/json', 'Authorization': 'Bearer '+token }, body: JSON.stringify(payload) });
        const txt = await res.text();
        if(res.ok){
          try{
            const j = JSON.parse(txt);
            const pr = (j && j.pull_request) ? j.pull_request : (j && j.result && j.result.pull_request) ? j.result.pull_request : null;
            if(pr && pr.html_url){
              prLink.href = pr.html_url; prLink.textContent = 'Open PR'; ghStatus.textContent = 'PR created';
            } else if(j && j.prUrl) {
              prLink.href = j.prUrl; prLink.textContent = 'Open PR'; ghStatus.textContent = 'PR created';
            } else {
              ghStatus.textContent = 'Saved (no PR info)';
            }
          }catch(e){ ghStatus.textContent = 'Saved'; }
        } else { alert('Save failed: '+txt); }
      }catch(err){ alert('Save failed: '+err); }
    });
  </script>
</body>
</html>
